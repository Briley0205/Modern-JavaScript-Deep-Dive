## 📕 오늘 공부한 내용, 이렇게 정리해 봅시다. ✒

**TIL(Today I learn) 기록일** : 2022.09.07

**오늘 읽은 범위** : 38장 브라우저의 렌더링 과정

### 브라우저의 렌더링 과정 요약 📑

1. 렌더링에 필요한 요소들 서버에 요청, 브라우저 내장 엔진 2개를 부른다.
2. `렌더링 엔진`이 응답된 html을 DOM, CSS를 CSSOM으로 파싱하여 렌더트리를 생성
3. `자바스크립트 엔진`이 응답된 JavaScript 파일을 AST Abstract Syntax 트리를 생성(트리가 2개다)하고 바이트코드로 변환하여 실행한다.
4. 이때 JavaScript는 DOM API를 통해 DOM, CSSOM을 변경할 수 있다.
   4-1. 변경 작업이 끝나면 DOM, CSSOM은 다시 렌더트리로 합쳐진다. (리페인팅)
5. 렌더트리를 기반으로 HTML 요소의 레이아웃을 계산하고 화면에 HTML 요소를 페인팅한다.

- 면접에 자주 나오니 꼭 외우기

### 용어

- 파싱 : 파싱=구문분석, 프로그래밍 언어에 맞게 작성된 텍스트문서를 읽어들여 실행하기 위해 텍스트문서의 문자열을 토큰으로 분해(어휘 분석)하고 토큰에 문법적 의미와 구조를 반영하여 심텍스트리(파스 트리)를 생성하는 일련의 과정을 말한다.

- 파싱 !== 쪼개기가 아니다. 쪼개고 트리를 만드는거까지다. 일반적으로 파싱이 완료된 이후에는 파스 트리를 기반으로 중간언어인 바이트코드를 생성하고 실행한다.

- 렌더링 : HTML, CSS, JavaScript로 된 문서를 파싱하여 브라우저에 시각적으로 출력하는 것.

- DNS : 도메인 네임 시스템. 사람이 알아보기 쉽게 만든 주소
- IP 주소 : 실제로 컴퓨터가 쓰는 주소

- 루트 요청 : / 요청, 뒤에 키워드 없이 스킴과 호스트만으로 구성된 URI 요청. 루트 요청에는 명확히 리소스를 요청하는 내용이 없지만 보통 서버는 암묵적으로 index.html을 응답하도록 되어 있다.

- 루트 요청만 하더라도 CSS, 자바스크립트, 이미지, 폰트가 전부 응답된다. 이렇게 불러와질 수 있는 이유는 브라우저의 렌더링 엔진이 html을 파싱하는 도중 외부 리소스를 로드하는 태그를 만나면 html 파싱을 일시중단하고 해당 리소스 파일을 서버로 요청하기 때문이다.

- 추상적 구문 트리(AST) : 자바스크립트를 해석한 트리. 토크나이징(토큰으로 분해) -> 파싱 -> AST 생성 -> 바이트코드 생성 -> 인터프리터로 실행의 순서다.

- 렌더트리 : 렌더트리는 렌더링을 위한 트리구조의 자료구조다. 따라서 브라우저 화면에 렌더링되지 않는 노드(script, meta)와 css에 의해 비표시(display: none)되는 노드들은 포함하지 않는다. 렌더트리를 기반으로 브라우저는 레이아웃을 계산하는데 변경사항이 있을때마다 계산을 다시 한다. 이를 리플로우라고 한다.

## 페인팅과 리렌더링과 리렌더링이 일어나는 CSS

- 페인팅 : 브라우저가 실제로 화면을 그리는 작업, 렌더트리를 기반으로 계산해서 페인팅을 시행한다. 자바스크립트 등에 의해 변경이 있을 경우 페인팅 작업을 다시 시행하는데 이를 리페인트라고 한다.

- 리렌더링 : 리플로우와 리페인트를 합쳐서 리렌더링이라고 부른다. 리렌더링은 비용이 많이 드는, 성능에 악영향을 주는 작업이다. 최대한 줄여보자.

- 리플로우는 위치나 크기, 노드 존재유무의 변화, 윈도우 리사이징 등에 따라 발생하고 반드시 리페인트가 따라온다. 리페인트가 단독으로 발생하는 경우는 색 변경이나 글씨변경 같이 레이아웃에 변화가 없을때이다. 사용자 경험을 위해서도 요소의 급격한 위치변화는 자제하도록 하자.

- 리플로우가 발생하는 경우(css할때 3번을 고려하기)

1. 자바스크립트에 의한 노드 추가 또는 삭제
2. 브라우저 창의 리사이징에 의한 뷰포트 크기 변경
3. HTML 요소의 레이아웃(위치, 크기)에 변경을 발생시키는 width, height, margin, padding, border, display, position, 좌표변경(top, left, right, bottom)

### 자바스크립트 파싱에 의한 html 파싱 중단

- 브라우저의 렌더링 엔진과 자바스크립트 엔진은 앞서 본 듯이 동기적으로 실행된다. 하나 끝나야 다음꺼가 실행된다.

- 위에서 아래로 실행하기에 자바스크립트를 호출하는 script태그의 위치가 중요하다. DOM API를 써야하는데 DOM의 생성이 완료되지 않으면 에러가 발생할 수 있기 때문이다.

- script 잘 보이는게 편해서 매번 헤더태그 밑에 놓고 썼는데 반성해야겠다. dom을 직접적으로 변경하는 애라면 body가 끝나기 전에 넣어두는게 안전하다.

- 하지만 이렇게 중단되는 문제를 근본적으로 해결하기 위해 html5에서는 async와 defer를 제공한다. 자바스크립트 파일을 외부에서 import할때만 사용할 수 있는 어트리뷰트이다.

- 둘다 비동기적으로 HTML파싱 + 외부 자바스크립트 파일 로드를 해주는 건 같지만 다음과 같은 차이가 있다.

```js
<script async src="ex.js"></script>
// 자바스크립트 파일의 로드가 완료된 직후 바로 파싱과 실행을 한다. 이때 HTML 파싱은 중단된다. 빨리 실행되어야 할 파일엔 이걸 쓰자.

<script defer src="ex.js"></script>
// HTML 파싱이 완료된 직후 = DOM 생성이 완료된 직후 자바스크립트가 파싱/실행된다. DOM 생성이 완료된 이후 실행되어야 할 파일엔 이걸 쓰자.
```
