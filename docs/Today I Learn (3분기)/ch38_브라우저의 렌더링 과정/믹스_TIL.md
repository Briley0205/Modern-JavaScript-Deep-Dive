## 📕 『모던 자바스크립트 Deep Dive』 오늘 읽은 내용 ✒

**TIL(Today I learn) 기록일** : 2022.09.07

### 38장 브라우저의 렌더링 과정 📑

---
> 웹 애플리케이션의 클라이언트 자바스크립트는 브라우저에서 HTML, CSS와 함께 실행된다. 따라서 브라우저 환경을 고려할 때 더 효율적인 클라이언트 사이드 자바스크립트 프로그래밍이 가능하다. 이를 위해 브라우저가 작성된 텍스트 문서를 파싱하여 브라우저에 랜더링하는지 알아볼 필요가 있다.

---
### 요청과 응답
랜더링에 필요한 리소스는 모두 서버에 존재한다. 브라우저의 핵심 기능은 __필요한 리소스를 서버에 요청하고 응답받아 리소스를 파싱하고 랜더링한다.__

서버에 요청을 전송하기 위해 브라우저는 주소창을 제공한다.
URL의 호스트 이름이 DNS를 통해 IP 주소로 변환되고 이 IP 주소를 갖는 서버에게 요청을 전송한다. 이 때 <u>브라우저 랜더링 엔진이 HTML을 파싱하면서 외부 리소스를 로드하는 태그도 읽으며 해당 리소스 파일 또한 서버에 요청</u>해 가져온다.

---
### HTTP 1.1 HTTP 2.0
HTTP는 웹에서 브라우저와 서버가 통신하기 위한 프로토콜(규약)이다.
HTTP1.1은 기본적으로 커넥션당 하나의 요청과 응답만 처리한다. 즉 리소스의 동시 전송이 불가능한 구조로 요청할 리소스의 개수에 비례하여 응답 시간도 증가한다.

HTTP2.0의 경우 커넥션당 여러 개의 요청과 응답, 즉 다중 요청/응답이 가능하다.

---
### HTML 파싱과 DOM 생성
문자열로 이루어진 순수한 텍스트
문서를 브라우저에 시각적인 픽셀로 랜더링하려면 문서를 브라우저가 이해할 수 있는 자료구조(객체)롤 변환하여 메모리에 저장해야 한다.

> 바이트 -> 문자 -> 토큰 -> 노드 -> DOM

---
### CSS 파싱과 CSSOM 생성
1. 랜더링 엔진은 HTML을 순차적으로 파싱하며 DOM을 생성해 나가다 CSS를 로드하는 태그를 만나면 생성을 일시 중단한다.
2. 지정된 CSS파일을 서버에 요청하여 HTML과 동일한 파싱 과정을 거치며 해석하고 __CSSOM__ 을 생성한다.
3. 완료 후 파싱이 중단된 지점부터 다시 HTML을 파싱하고 DOM을 생성한다.

---
### 렌더 트리 생성
렌더링 엔진은 서버로부터 응답된 HTML CSS 파싱 -> 각각 DOM과 CSSOM을 생성한다. 그리고 랜더링을 위해 둘은 결합된다. 이를 랜더 트리라하는데 브라우저 화면에 래너링되는 노드만으로 구성된다.

이후 완성된 랜더 트리는 HTML 요소의 레이아웃을 계산하는 데 사용되며 픽셀을 랜더링하는 페인팅 처리에 입력된다.

- 자바스크립트에 의한 노드 추가 or 삭제
- 브라우저 창의 리사이징
- HTML 레이아웃 변경
등 경우에 반복해서 레이아웃 계산과 페인팅이 실행된다.

-> 가급정 리랜더링이 빈번하게 발생하지 않도록!

---
### 자바스크립트 파싱과 실행
자바스크립트 코드에서 DOM API를 사용하면 이미 생성된 DOM을 동적으로 조작할 수 있다.
1. 자바스크립트 파일 역시 HTML의 DOM 생성을 일시 중단시킨다.
2. 그리고 자바스크립트 코드 파싱은 자바스크립트 엔진에게 제어권이 넘어간다. 
3. 파싱 종료 후 렌더링 엔진으로 다시 제어권이 넘어간다.

자바스크립트 엔진은 코드를 파싱하여 CPU가 이해할 수 있는 저수준 언어로 변환하고 실행한다. 그리고 AST를 생성한다. -> 이것을 기반으로 인터프리터가 실행 할 수 있는 중간 코드인 바이트코드를 생성하여 실행한다.

> 토크나이징 : JS 어휘 분석 후 토큰으로 분해 -> 파싱 : AST 생성 -> 바이트코드 생성과 실행 : 인터프리터가 실행할 수 있는 중간 코드인 바이트코드로 변화, 인터프리터에 의해 실행

---
### 리플로우와 리페인트
DOM API가 사용된 경우 DOM이나 CSSOM이 변경된다. 이때,
1. 리플로우는 __레이아웃 계산__ 을 다시 하는 것을 말하며 레이아웃에 영향을 주는 변경이 발생한 경우에 한하여 실행된다.
2. 리페인트는 재결합된 랜더 트리를 기반으로 __다시 페인트 하는 것__ 을 말한다.

이런 변경 사항은 다시 렌더 트리로 결합되고 변경된 렌더 트리를 기반으로 레이아웃과 페인트 과정을 거쳐 브라우저 화면에 다시 렌더링한다.

---
### 자바스크립트 파싱에 의한 HTML 파싱 중단과 script 태그의 async/defer 어트리뷰트
자바스크립트 엔진과 렌더링 엔진은 __직렬적으로 파싱을 수행한다.__ 이는 <u>script 태그의 위치에 따라</u> HTML 파싱이 블로킹되어 DOM 생성이 지연될 수 있다는 것을 의미하며 태그의 위치가 중요한 의미를 가진다.
script 태그는 body 요소의 가장 아래 두는 것이 좋다.

또 이런 문제를 해결하기 위한 async과 defer 어트리뷰트가 있다.
단 이 둘은 외부 자바스크립트를 로드하는 경우에만 사용 가능하다. 이 둘을 사용하면 비동기적으로 동시에 로드르 진행할 수 있다.

- async<br>
HTML 파싱과 외부 JS 파일의 __로드가 비동기적으로 동시에 진행__ 되지만 __파싱과 실행은 파일의 로드가 완료된 직후 진행__ 되며, 이때는 <u>HTML 파싱이 중단된다.</u><br>
단, 여러개의 async 어트리뷰트 지정된 script가 있다면 __태그 순서와 상관없이 로드가 완료된 순서대로 실행__ 되므로 의도한 순서가 보장되지 않는다.
- defer<br>
역시 파일의 __로드가 비동기적으로 동시에 진행__ 되며 __파싱은 HTML 파싱이 완료된 직후에 실행__ 된다. DOM 생성 완료 후 실행되어야 할 JS에 유용하다. 